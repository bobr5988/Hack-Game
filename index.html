<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>RBMK ULTIMATE INFILTRATOR</title>

    <link rel="manifest" href="manifest.json">

    <meta name="theme-color" content="#010501">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RBMK Hack">
    
    <link rel="apple-touch-icon" href="icon.png">
    
    <style>
        /* Весь ваш CSS остается без изменений */
        :root {
            --green: #00ff41;
            --dark: #001a00;
            --bg: #010501;
            --warn: #ffb000;
            --crit: #ff1111;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Courier New', Courier, monospace;
            touch-action: none;
        }

        body {
            background-color: var(--bg);
            color: var(--green);
            margin: 0; height: 100dvh;
            display: flex; flex-direction: column;
            overflow: hidden;
            text-transform: uppercase;
            padding: env(safe-area-inset-top) 10px env(safe-area-inset-bottom) 10px;
        }

        header {
            padding: 10px 0; background: #050a05;
            border-bottom: 2px solid var(--dark);
            font-size: 10px; flex-shrink: 0;
        }

        .stat-line { display: flex; justify-content: space-between; margin-bottom: 4px; }
        
        .progress-container {
            width: 100%; height: 6px; background: #000;
            border: 1px solid var(--dark); overflow: hidden;
        }
        #global-bar { width: 0%; height: 100%; background: var(--green); transition: width 0.5s; }

        #terminal {
            flex-grow: 1; padding: 10px 0;
            overflow-y: auto; font-size: 12px;
            display: flex; flex-direction: column; gap: 5px;
        }

        .line { word-break: break-all; line-height: 1.2; }
        .line.sys { color: var(--warn); }
        .line.err { color: var(--crit); }
        .line.ok { text-shadow: 0 0 5px var(--green); }
        .line.dead { color: #222; text-decoration: line-through; }

        #hack-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 5000; display: none; flex-direction: column;
            align-items: center; justify-content: space-evenly; padding: 10px;
        }

        .game-window {
            position: relative; border: 2px solid var(--green);
            width: 280px; height: 280px; background: #000;
        }
        canvas { width: 100%; height: 100%; display: block; }

        .dpad {
            display: grid;
            grid-template-columns: repeat(3, 70px);
            grid-template-rows: repeat(3, 70px);
            gap: 10px;
        }
        .dbtn {
            background: rgba(0,255,65,0.05); border: 1px solid var(--green);
            color: var(--green); display: flex; align-items: center;
            justify-content: center; font-size: 24px; border-radius: 10px;
        }

        #input-area {
            background: #000; padding: 10px 0;
            border-top: 2px solid var(--dark); flex-shrink: 0;
        }

        .input-preview { font-size: 14px; margin-bottom: 10px; border-left: 3px solid var(--green); padding-left: 10px; height: 20px;    	 display: flex; align-items: center;}
        .keys-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .key {
            background: #0a110a; border: 1px solid var(--dark);
            color: var(--green); padding: 14px 0; font-size: 18px; border-radius: 4px;
        }
        .key:active { background: var(--green); color: #000; }
        .key-fn { grid-column: span 2; font-size: 10px; background: #001a00; }

        @keyframes shake {
            0% { transform: translate(0,0); }
            25% { transform: translate(2px, -2px); }
            50% { transform: translate(-2px, 2px); }
            75% { transform: translate(2px, 2px); }
            100% { transform: translate(0,0); }
        }
        .shaking { animation: shake 0.1s infinite; }
    </style>
</head>
<body>
<header>
        <div class="stat-line">
            <span>MOD: RBMK_ROGUE_V5</span>
            <span>PUMPS: <span id="p-count">0/6</span></span>
        </div>
        <div class="progress-container"><div id="global-bar"></div></div>
        <div class="stat-line" style="margin-top:4px">
            <span>RISK: <span id="risk-val">0</span>%</span>
            <span id="mode-status" style="color:var(--warn)">INIT_SESSION</span>
        </div>
    </header>

    <div id="terminal"></div>

    <div id="hack-overlay">
        <div id="hack-task" style="font-size:12px">BUFFER_OVERFLOW_EXPLOIT</div>
        <div class="game-window"><canvas id="gameCanvas"></canvas></div>
        <div id="snake-ctrl" class="dpad" style="display:none">
            <div style="grid-column:2" class="dbtn" id="btn-up">▲</div>
            <div style="grid-row:2; grid-column:1" class="dbtn" id="btn-left">◀</div>
            <div style="grid-row:2; grid-column:3" class="dbtn" id="btn-right">▶</div>
            <div style="grid-row:3; grid-column:2" class="dbtn" id="btn-down">▼</div>
        </div>
        <div id="fw-hint" style="font-size:10px; color:var(--warn); text-align:center">INTERCEPT_WAVE_NOW<br>TAP_SCREEN</div>
    </div>

    <div id="input-area">
        <div class="input-preview">USER@ROOT:~$ <span id="buffer" style="margin-left:5px"></span></div>
        <div class="keys-grid">
            <button class="key" onclick="k('1')">1</button>
            <button class="key" onclick="k('2')">2</button>
            <button class="key" onclick="k('3')">3</button>
            <button class="key key-fn" onclick="c('SCAN')">SCAN</button>
            <button class="key" onclick="k('4')">4</button>
            <button class="key" onclick="k('5')">5</button>
            <button class="key" onclick="k('6')">6</button>
            <button class="key key-fn" onclick="c('HACK ')">HACK</button>
            <button class="key" onclick="k('7')">7</button>
            <button class="key" onclick="k('8')">8</button>
            <button class="key" onclick="k('9')">9</button>
            <button class="key key-fn" onclick="c('')">CLR</button>
            <button class="key" onclick="k('0')">0</button>
            <button class="key key-fn" style="grid-column:span 4; background:#002a00" onclick="run()">EXECUTE_CMD</button>
        </div>
    </div>

    <script>
        const audio = new (window.AudioContext || window.webkitAudioContext)();
        let buf = "";
        let risk = 0;
        let pActive = null;
        let pDead = [];
        let state = "IDLE";
        let targetId = null;
        let currentQuiz = null;

        const rawQuiz = [
            { q: "FUEL_TYPE?", a: "URANIUM", o: ["URANIUM", "PLUTONIUM", "THORIUM"] },
            { q: "MODERATOR?", a: "GRAPHITE", o: ["GRAPHITE", "WATER", "BORON"] },
            { q: "SCRAM_CMD?", a: "AZ-5", o: ["AZ-5", "EPS-1", "STOP"] },
            { q: "PRESSURE?", a: "7_MPA", o: ["7_MPA", "15_MPA", "1_MPA"] },
            { q: "TEMP_LIMIT?", a: "700C", o: ["700C", "300C", "1500C"] },
            { q: "COOLANT?", a: "H2O", o: ["H2O", "CO2", "HELIUM"] },
            { q: "CORE_HEIGHT?", a: "7_METERS", o: ["7_METERS", "2_METERS", "20_METERS"] }
        ];

        function play(f, d, t='square', g=0.02) {
            try {
                const o = audio.createOscillator();
                const v = audio.createGain();
                o.type = t; o.frequency.setValueAtTime(f, audio.currentTime);
                v.gain.setValueAtTime(g, audio.currentTime);
                v.gain.exponentialRampToValueAtTime(0.0001, audio.currentTime + d);
                o.connect(v); v.connect(audio.destination);
                o.start(); o.stop(audio.currentTime + d);
            } catch(e) {}
        }

        async function log(text, type='') {
	    const div = document.createElement('div');
            div.className = 'line ' + type;
            const term = document.getElementById('terminal');
            term.appendChild(div);
            const msg = text.replace(/ /g, "_");
            for (let char of msg) {
                div.innerText += char;
                if(Math.random() > 0.7) play(400 + Math.random()*200, 0.02, 'sine', 0.002);
                await new Promise(r => setTimeout(r, 10));
            }
            term.scrollTop = term.scrollHeight;
        }

        function k(v) { buf += v; document.getElementById('buffer').innerText = buf; play(600, 0.05); }
        function c(v) { buf = v; document.getElementById('buffer').innerText = buf; play(800, 0.05); }

        async function run() {
            if (state === "BOOM") return;
            const cmd = buf.trim().toUpperCase();
            buf = ""; document.getElementById('buffer').innerText = "";
            play(1000, 0.1);

            if (state === "IDLE") {
                if (cmd === "SCAN") {
                    if (!pActive) pActive = Array.from({length: 6}, () => Math.floor(100 + Math.random() * 899));
                    await log("SCANNING_LOCAL_SEGMENT");
                    await new Promise(r => setTimeout(r, 500));
                    for (let id of pActive) {
                        const dead = pDead.includes(id);
                        await log(NODE_${id}:_${dead ? "OFFLINE" : "READY"}, dead ? "dead" : "ok");
                    }
                } 
                else if (cmd.startsWith("HACK") || (pActive && pActive.includes(parseInt(cmd)))) {
                    let val = parseInt(cmd.replace("HACK", "").trim());
                    if (isNaN(val)) val = parseInt(cmd);
                    
                    if (pActive && pActive.includes(val)) {
                        if (pDead.includes(val)) await log("ALREADY_COMPROMISED", "err");
                        else { targetId = val; startQuiz(); }
                    } else await log("NODE_NOT_RECOGNIZED", "err");
                }
                else if (cmd === "") document.getElementById('terminal').innerHTML = "";
            } 
            else if (state === "QUIZ") {
                checkQuiz(cmd);
            }
        }

        function startQuiz() {
            state = "QUIZ";
            const item = rawQuiz[Math.floor(Math.random() * rawQuiz.length)];
            const shuffled = [...item.o].sort(() => Math.random() - 0.5);
            currentQuiz = {
                q: item.q,
                a: (shuffled.indexOf(item.a) + 1).toString(),
                options: shuffled.map((o, i) => ${i+1}.${o}).join(" | ")
            };
            log("SECURITY_CHALLENGE_REQUIRED", "sys");
            log(currentQuiz.q);
            log(currentQuiz.options);
        }

        async function checkQuiz(ans) {
            if (ans === currentQuiz.a) {
                await log("VERIFICATION_COMPLETE", "ok");
                setTimeout(initFirewall, 600);
            } else {
                await log("VERIFICATION_FAILED_ALERT_SENT", "err");
                risk += 15;
                document.getElementById('risk-val').innerText = risk;
                state = "IDLE";
                if(risk >= 100) explodeTerminal();
            }
        }

        const canv = document.getElementById('gameCanvas');
        const gctx = canv.getContext('2d');
        let fwAngle = 0, fwTarget = 0, fwLoop;

        function initFirewall() {
            state = "FIREWALL";
            document.getElementById('hack-overlay').style.display = 'flex';
            document.getElementById('snake-ctrl').style.display = 'none';
            document.getElementById('fw-hint').style.display = 'block';
            canv.width = 280; canv.height = 280;
            fwTarget = Math.random() * Math.PI * 1.5 + 0.5;
            fwLoop = requestAnimationFrame(drawFirewall);
	    canv.onclick = () => {
                let diff = Math.abs(fwAngle % (Math.PI*2) - fwTarget);
                if (diff < 0.5 || diff > 5.7) {
                    cancelAnimationFrame(fwLoop);
                    play(1500, 0.2, 'sine');
                    initSnake();
                } else {
                    cancelAnimationFrame(fwLoop);
                    failHack("SYNC_INTERRUPTED");
                }
            };
        }

        function drawFirewall() {
            gctx.clearRect(0,0,280,280);
            gctx.strokeStyle = "#001a00"; gctx.lineWidth = 15;
            gctx.beginPath(); gctx.arc(140, 140, 90, 0, Math.PI*2); gctx.stroke();
            gctx.strokeStyle = "#00ff41";
            gctx.beginPath(); gctx.arc(140, 140, 90, fwTarget-0.4, fwTarget+0.4); gctx.stroke();
            fwAngle += 0.04;
            gctx.strokeStyle = "#fff"; gctx.lineWidth = 20;
            gctx.beginPath(); gctx.arc(140, 140, 90, fwAngle-0.1, fwAngle+0.1); gctx.stroke();
            if (state === "FIREWALL") fwLoop = requestAnimationFrame(drawFirewall);
        }

        let snake, food, dir, sLoop;
        function initSnake() {
            state = "SNAKE";
            document.getElementById('snake-ctrl').style.display = 'grid';
            document.getElementById('fw-hint').style.display = 'none';
            canv.onclick = null;
            snake = [{x:10, y:10}]; food = {x:5, y:5}; dir = {x:1, y:0};
            sLoop = setInterval(drawSnake, 160);
        }

        function drawSnake() {
            const h = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};
            if (h.x<0  h.x>=20  h.y<0  h.y>=20  snake.some(s=>s.x===h.x && s.y===h.y)) {
                clearInterval(sLoop); failHack("DATA_STREAM_LOST"); return;
            }
            snake.unshift(h);
            if(h.x===food.x && h.y===food.y) {
                play(2000, 0.04, 'sine');
                if(snake.length >= 5) { clearInterval(sLoop); winHack(); return; }
                food = {x:Math.floor(Math.random()*18)+1, y:Math.floor(Math.random()*18)+1};
            } else snake.pop();
            gctx.fillStyle = "#000"; gctx.fillRect(0,0,280,280);
            gctx.fillStyle = "#00ff41";
            snake.forEach(s=>gctx.fillRect(s.x*14, s.y*14, 13, 13));
            gctx.fillStyle = "#ffb000"; gctx.fillRect(food.x*14, food.y*14, 13, 13);
        }

        function failHack(m) {
            document.getElementById('hack-overlay').style.display = 'none';
            state = "IDLE";
            log(m || "HACK_FAILED", "err");
        }

        async function winHack() {
            document.getElementById('hack-overlay').style.display = 'none';
            pDead.push(targetId);
            state = "IDLE";
            document.getElementById('p-count').innerText = ${pDead.length}/6;
            document.getElementById('global-bar').style.width = (pDead.length/6)*100 + "%";
            await log("NODE_DEACTIVATED_SUCCESSFULLY", "ok");
            if (pDead.length === 6) runFinalSequence();
        }

        async function runFinalSequence() {
            state = "BOOM";
            document.getElementById('mode-status').innerText = "CRITICAL";
            document.getElementById('mode-status').style.color = "red";
            await log("ALL_NODES_OFFLINE_MELTDOWN_INIT", "err");
            await new Promise(r => setTimeout(r, 1000));
            
            const term = document.getElementById('terminal');
            term.innerHTML = "";
            
            let counter = 0;
            const finalInterval = setInterval(() => {
                term.innerHTML = <div class='line err'>!!! EMERGENCY_OVERHEAT !!!</div>;
                const lid = [
                    "    .-------.    ",
                    "  /  # # # #  \\  ",
                    " |  # # # # #  | ",
		    " |  # # # # #  | ",
                    "  \\  # # # #  /  ",
                    "    '-------'    "
                ];
                lid.forEach(l => {
                    const line = document.createElement('div');
                    line.className = 'line shaking';
                    line.style.marginLeft = Math.random()*20 + "px";
                    line.innerText = l.split('').map(c => Math.random() > 0.7 ? '@' : c).join('');
                    term.appendChild(line);
                });
                play(200 + Math.random()*2000, 0.05, 'sawtooth', 0.02);
                counter++;
                if (counter > 40) {
                    clearInterval(finalInterval);
                    document.body.style.background = "white";
                    document.body.innerHTML = "";
                    play(40, 3, 'sawtooth', 0.5);
                    setTimeout(() => location.reload(), 4000);
                }
            }, 80);
        }

        function explodeTerminal() {
            document.body.innerHTML = "<div style='color:red; text-align:center; padding-top:100px'>CONNECTION_CLOSED_BY_SECURITY</div>";
            play(50, 2, 'sawtooth', 0.2);
            setTimeout(() => location.reload(), 3000);
        }

        document.getElementById('btn-up').ontouchstart = (e) => { e.preventDefault(); if(dir.y===0) dir={x:0, y:-1}; };
        document.getElementById('btn-down').ontouchstart = (e) => { e.preventDefault(); if(dir.y===0) dir={x:0, y:1}; };
        document.getElementById('btn-left').ontouchstart = (e) => { e.preventDefault(); if(dir.x===0) dir={x:-1, y:0}; };
        document.getElementById('btn-right').ontouchstart = (e) => { e.preventDefault(); if(dir.x===0) dir={x:1, y:0}; };

        log("SYSTEM_V5_STABLE");
        log("SCAN_NETWORK_TO_START");
    </script>
</body>
</html>